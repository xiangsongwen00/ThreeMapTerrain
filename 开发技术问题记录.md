<!--
 * @Author: 2409479323@qq.com
 * @Date: 2026-02-03 15:51:52
 * @LastEditors: 2409479323@qq.com 
 * @LastEditTime: 2026-02-03 15:53:02
 * @FilePath: \RammedEarth\开发技术问题记录.md
 * @Description: 
 * 
 * Copyright (c) 2026 by bimcc, All Rights Reserved. 
-->
# TGIS开发技术问题记录（与当前实现一致）

> 目的：记录本项目在实现“局部地形 + 影像铺设 + 测量/填挖方 + 地形修整”过程中遇到的关键技术问题、踩坑点与当前代码里的解决方式。
> 
> 说明：本文件不是需求文档；如果只想了解怎么跑起来/怎么配参数，请看 `README.md`。

## 1. 坐标系与投影一致性（最常见坑）

### 1.1 现象
- 工具拾取点看起来对，但经纬度/方向（东南西北）反了。
- “北”方向移动后，Three.js 的 Z 却变大。

### 1.2 结论（本项目约定）
- 经纬度：WGS84（EPSG:4326）
- 投影：Web Mercator（EPSG:3857）
- Three.js 本地坐标：以 `centerLon/centerLat` 的墨卡托为原点

轴向对齐（`src/math/proj.js`）：
- three +X：地理东
- three +Y：向上（高程）
- three +Z：地理南（所以地理北 = -Z）

### 1.3 当前实现
- `src/math/proj.js` 的 `mercatorToThree()/threeToMercator()` 将 Web Mercator 的 Y 轴映射到 Three 的 Z（并做反号）以满足 “-Z 为北”。

## 2. “地形开关”的语义：不是隐藏，而是“高程开关”

### 2.1 现象
- UI 里“地形关闭”后仍然能看到地形网格/瓦片，用户以为开关无效。

### 2.2 当前设计
- 本项目中 `terrainVisible` 表示 **是否启用真实高程**：
  - `true`：使用 terrain-rgb 的高程
  - `false`：渲染一张 y=0 的平面（地形存在但“高程为 0”）

### 2.3 当前实现
- `src/viewer.js`：`setTerrainVisibility()` 同步 `terrainVisible`，并调用 `updateAuxiliaryToolsHeight()`
- `src/terrain/Terrain.js`：`setTerrainVisibility()` 更新每个 tile 的几何（真实高程 / 平面）

## 3. XYZ/TMS 瓦片方案差异导致“贴图上下翻/错位”

### 3.1 现象
- 底图上下翻转。
- 同一地物在不同缩放级别出现明显错位。

### 3.2 原因
- 不同服务的 `{y}` 方向不同：
  - XYZ：y 原点在北（顶部），向南递增
  - TMS：y 原点在南（底部），向北递增

### 3.3 当前实现
- `src/maptiles/imageryTiles.js` 支持 `tileScheme: 'xyz' | 'tms'`，并在请求与子瓦片裁剪时处理 y 方向。
- `src/maptiles/basemaps.js` 的预设会提供 `mapYtype`。

## 4. 严格底图服务的限流与重试（以天地图为例）

### 4.1 现象
- 初始化时请求过猛，出现 429/空响应，影像加载断断续续。

### 4.2 当前实现
- `src/maptiles/imageryTiles.js`：
  - 并发队列（`maxConcurrent`）
  - 简单 burst 限流（`rateLimitBurst/window/cooldown`）
  - 重试 + 退避（`retryCount/retryBaseDelayMs/retryMaxDelayMs`）
- `src/maptiles/basemaps.js`：天地图预设建议更保守的并发与限流参数。

## 5. 影像铺设 LOD：`mapZoom` 与 `terrainZoom` 不一致

### 5.1 现象
- `mapZoom > terrainZoom` 时，如果直接按地形 tile 一张贴图，会缺细节。
- 过度提升 `mapZoom` 会导致请求数量爆炸。

### 5.2 当前实现
- `src/maptiles/imageryTiles.js`：
  - `mapZoom < terrainZoom`：用父级一张贴图，通过 `offset/repeat` 精确裁剪到子瓦片
  - `mapZoom == terrainZoom`：一 tile 一贴图
  - `mapZoom > terrainZoom`：多瓦片拼接（mosaic）到一张 CanvasTexture（可用 `mapMaxZoomDiff` 限制）

## 6. 地形修整/裁剪：需要正确使用 local clipping + 新瓦片继承

### 6.1 现象
- 裁剪洞在当前瓦片有效，视角移动/瓦片重建后洞消失。
- 编辑补丁与底层地形 z-fighting（闪烁）。

### 6.2 当前实现
- `src/terrain/TerrainEditor.js`：
  - 通过“多边形 mask + clipping planes”实现替换/洞
  - `editPatchEpsilon` 用于把补丁抬起极小高度避免 z-fighting
  - `applyCurrentMaskAndClippingToMaterial()`：新生成/新贴图材质时，把当前 mask/clipping 状态同步过去
  - 自动开启 `renderer.localClippingEnabled`（只在确实存在 clipping planes 时）

## 7. 填挖方（cut/fill）精度与性能：采样步长是关键参数

### 7.1 现象
- 采样太密：计算慢、卡顿。
- 采样太稀：体积误差明显。

### 7.2 当前实现
- `src/toolManager/UI/measureToolUI.js`：
  - 以多多边形为输入，支持凹多边形（内部会三角化/采样）
  - 通过 `cutFillSampleStepMeters` 控制采样步长（米）
  - 支持“执行（整平）/撤销”一类流程（执行后会修改地形补丁；清理时需要恢复）
- 贴地可视化：`src/terrain/CustomTerrainSurface.js`

## 8. 资源与缓存：纹理必须在驱逐时释放

### 8.1 现象
- 长时间操作后显存/内存持续上升。

### 8.2 当前实现
- `src/maptiles/imageryTiles.js`：LRU 缓存对纹理做驱逐释放（含 mosaic/clone 的情况）。
- `src/drawTool/DrawTool.js`、`src/toolManager/UI/measureToolUI.js`：销毁时清理 Mesh/材质/贴地表面。

## 9. 中文标签显示为“?”：使用 CanvasTexture 的 Sprite

### 9.1 现象
- 直接用 TextGeometry/某些字体方案时，中文容易缺字或显示为“?”。

### 9.2 当前实现
- `src/viewer.js`：坐标轴文字标签用 canvas 绘制，然后生成 `THREE.CanvasTexture` + `THREE.Sprite`。

## 10. 已知问题（当前版本）

- `index.html` 里存在 importmap + 额外 `</script>` 的历史遗留写法（对 Vite 开发可能不致命，但建议后续清理）。
- `src/assest/` 目录名为 `assest`（拼写），目前代码与资源路径均基于该拼写，短期不建议改名。

---

变更建议（可选）：如果希望把项目真正作为可复用 SDK 输出，建议把 `vite.config.js` 的 lib entry 调整为“导出 `Viewer`/工具类”的入口文件，而不是当前带副作用的 `src/index.js`（demo 启动）。